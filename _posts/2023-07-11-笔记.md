---
title: "一些简单笔记"
layout: post
date: 2023-07-11
image: /assets/images/markdown.jpg
headerImage: false
tag:
- 笔记
category: 笔记
---

## 进程、线程、协程

进程，直观点说，保存在硬盘上的程序运行以后，会在内存空间里形成一个独立的内存体，这个内存体有自己独立的地址空间，有自己的堆，上级挂靠单位是操作系统。操作系统会以进程为单位，分配系统资源（CPU时间片、内存等资源），进程是资源分配的最小单位。

### 进程间通信（IPC）：

+ 管道(Pipe)、命名管道(FIFO)、消息队列(Message Queue) 、信号量(Semaphore) 、共享内存（Shared Memory）、套接字（Socket）。

### 线程：

+ 线程，有时被称为轻量级进程(Lightweight Process，LWP），是操作系统调度（CPU调度）执行的最小单位。

### 进程和线程的区别和联系

#### 区别：

+ 调度：线程作为调度和分配的基本单位，进程作为拥有资源的基本单位；

+ 并发性：不仅进程之间可以并发执行，同一个进程的多个线程之间也可并发执行；

+ 拥有资源：进程是拥有资源的一个独立单位，线程不拥有系统资源，但可以访问隶属于进程的资源。进程所维护的是程序所包含的资源（静态资源）， 如：地址空间，打开的文件句柄集，文件系统状态，信号处理handler等；线程所维护的运行相关的资源（动态资源），如：运行栈，调度相关的控制信息，待处理的信号集等；

+ 系统开销：在创建或撤消进程时，由于系统都要为之分配和回收资源，导致系统的开销明显大于创建或撤消线程时的开销。但是进程有独立的地址空间，一个进程崩溃后，在保护模式下不会对其它进程产生影响，而线程只是一个进程中的不同执行路径。线程有自己的堆栈和局部变量，但线程之间没有单独的地址空间，一个进程死掉就等于所有的线程死掉，所以多进程的程序要比多线程的程序健壮，但在进程切换时，耗费资源较大，效率要差一些。

#### 联系：

+ 一个线程只能属于一个进程，而一个进程可以有多个线程，但至少有一个线程；

+ 资源分配给进程，同一进程的所有线程共享该进程的所有资源；

+ 处理机分给线程，即真正在处理机上运行的是线程；

+ 线程在执行过程中，需要协作同步。不同进程的线程间要利用消息通信的办法实现同步。

#### 示例：解释进程和线程的区别

+ 一个双向多车道的道路图，假如我们把整条道路看成是一个“进程”的话，那么图中由白色虚线分隔开来的各个车道就是进程中的各个“线程”了。

+ 这些线程(车道)共享了进程(道路)的公共资源(土地资源)。

+ 这些线程(车道)必须依赖于进程(道路)，也就是说，线程不能脱离于进程而存在(就像离开了道路，车道也就没有意义了)。

+ 这些线程(车道)之间可以并发执行(各个车道你走你的，我走我的)，也可以互相同步(某些车道在交通灯亮时禁止继续前行或转弯，必须等待其它车道的车辆通行完毕)。

+ 这些线程(车道)之间依靠代码逻辑(交通灯)来控制运行，一旦代码逻辑控制有误(死锁，多个线程同时竞争唯一资源)，那么线程将陷入混乱，无序之中。

+ 这些线程(车道)之间谁先运行是未知的，只有在线程刚好被分配到CPU时间片(交通灯变化)的那一刻才能知道。

#### 进程和线程的亲缘性（进程/线程只在某个cpu上运行（多核系统））

```
BOOL WINAPI SetProcessAffinityMask(
  _In_ HANDLE    hProcess,
  _In_ DWORD_PTR dwProcessAffinityMask
);
/* dwProcessAffinityMask 如果是 0 , 代表当前进程只在cpu0 上工作; 如果是 0x03 , 转为2进制是 00000011 . 代表只在 cpu0 或 cpu1上工作; */
```

  使用CPU亲缘性的好处：设置CPU亲缘性是为了防止进程/线程在CPU的核上频繁切换，从而避免因切换带来的CPU的L1/L2 cache失效，cache失效会降低程序的性能。

### 协程

+ 协程，是一种比线程更加轻量级的存在，协程不是被操作系统内核所管理，而完全是由程序所控制（也就是在用户态执行）。这样带来的好处就是性能得到了很大的提升，不会像线程切换那样消耗资源。   

+ 子程序，或者称为函数，在所有语言中都是层级调用，比如A调用B，B在执行过程中又调用了C，C执行完毕返回，B执行完毕返回，最后是A执行完毕。所以子程序调用是通过栈实现的，一个线程就是执行一个子程序。子程序调用总是一个入口，一次返回，调用顺序是明确的。而协程的调用和子程序不同。  

+ 协程在子程序内部是可中断的，然后转而执行别的子程序，在适当的时候再返回来接着执行。  

+ 协程的特点在于是一个线程执行，那和多线程比，协程有何优势？

+ 极高的执行效率：因为子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销，和多线程比，线程数量越多，协程的性能优势就越明显；

+ 不需要多线程的锁机制：因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了，所以执行效率比多线程高很多。

### Daemon（守护进程）

+ Daemon()程序是一直运行的服务端程序，又称为守护进程。通常在系统后台运行，没有控制终端，不与前台交互，Daemon程序一般作为系统服务使 用。Daemon是长时间运行的进程，通常在系统启动后就运行，在系统关闭时才结束。一般说Daemon程序在后台运行，是因为它没有控制终端，无法和前 台的用户交互。Daemon程序一般都作为服务程序使用，等待客户端程序与它通信。我们也把运行的Daemon程序称作守护进程。

+ 所谓守护线程，是指在程序运行的时候在后台提供一种通用服务的线程，比如垃圾回收线程就是一个很称职的守护者，并且这种线程并不属于程序中不可或缺的部分。因此， 当所有的非守护线程结束时，程序也就终止了，同时会杀死进程中的所有守护线程。反过来说，只要任何非守护线程还在运行，程序就不会终止。

+ 用户线程和守护线程两者几乎没有区别，唯一的不同之处就在于虚拟机的离开：如果用户线程已经全部退出运行了，只剩下守护线程存在了，虚拟机也就退出了。 因为没有了被守护者，守护线程也就没有工作可做了，也就没有继续运行程序的必要了。

### 多进程和多线程

+ 进程是资源分配的最小单位，线程是CPU调度的最小单位。线程和进程的区别在于,子进程和父进程有不同的代码和数据空间,而多个线程则共享数据空 间,每个线程有自己的执行堆栈和程序计数器为其执行上下文.多线程主要是为了节约CPU时间,发挥利用,根据具体情况而定. 线程的运行中需要使用计算机的内存资源和CPU。

+ 多进程： 进程是程序在计算机上的一次执行活动。当你运行一个程序，你就启动了一个进程。显然，程序是死的(静态的)，进程是活的(动态的)。进程可以分为系统进程 和用户进程。凡是用于完成操作系统的各种功能的进程就是系统进程，它们就是处于运行状态下的操作系统本身;所有由用户启动的进程都是用户进程。进程是操作 系统进行资源分配的单位。 进程又被细化为线程，也就是一个进程下有多个能独立运行的更小的单位。在同一个时间里，同一个计算机系统中如果允许两个或两个以上的进程处于运行状态，这 便是多任务。现代的操作系统几乎都是多任务操作系统，能够同时管理多个进程的运行。 多任务带来的好处是明显的，比如你可以边听mp3边上网，与此同时甚至可以将下载的文档打印出来，而这些任务之间丝毫不会相互干扰。那么这里就涉及到并行 的问题，俗话说，一心不能二用，这对计算机也一样，原则上一个CPU只能分配给一个进程，以便运行这个进程。我们通常使用的计算机中只有一个CPU，也就 是说只有一颗心，要让它一心多用，同时运行多个进程，就必须使用并发技术。实现并发技术相当复杂，最容易理解的是“时间片轮转进程调度算法”，它的思想简 单介绍如下：在操作系统的管理下，所有正在运行的进程轮流使用CPU，每个进程允许占用CPU的时间非常短(比如10毫秒)，这样用户根本感觉不出来 CPU是在轮流为多个进程服务，就好象所有的进程都在不间断地运行一样。但实际上在任何一个时间内有且仅有一个进程占有CPU。 如果一台计算机有多个CPU，情况就不同了，如果进程数小于CPU数，则不同的进程可以分配给不同的CPU来运行，这样，多个进程就是真正同时运行的，这 便是并行。但如果进程数大于CPU数，则仍然需要使用并发技术。 进行CPU分配是以线程为单位的，一个进程可能由多个线程组成，这时情况更加复杂，但简单地说，有如下关系：

		总线程数<= CPU数量：并行运行
		
		总线程数> CPU数量：并发运行

+ 并行运行的效率显然高于并发运行，所以在多CPU的计算机中，多任务的效率比较高。但是，如果在多CPU计算机中只运行一个进程(线程)，就不 能发挥多CPU的优势。 这里涉及到多任务操作系统的问题，多任务操作系统(如Windows)的基本原理是:操作系统将CPU的时间片分配给多个线程,每个线程在操作系统指定的 时间片内完成(注意,这里的多个线程是分属于不同进程的).操作系统不断的从一个线程的执行切换到另一个线程的执行,如此往复,宏观上看来,就好像是多个 线程在一起执行.由于这多个线程分属于不同的进程,因此在我们看来,就好像是多个进程在同时执行,这样就实现了多任务

+ 多线程：在计算机编程中，一个基本的概念就是同时对多个任务加以控制。许多程序设计问题都要求程序能够停下手头的工作，改为处理其他一些问题， 再返回主进程。可以通过多种途径达到这个目的。最开始的时候，那些掌握机器低级语言的程序员编写一些“中断服务例程”，主进程的暂停是通过硬件级的中断实 现的。尽管这是一种有用的方法，但编出的程序很难移植，由此造成了另一类的代价高昂问题。中断对那些实时性很强的任务来说是很有必要的。但对于其他许多问 题，只要求将问题划分进入独立运行的程序片断中，使整个程序能更迅速地响应用户的请求。

+ 最开始，线程只是用于分配单个处理器的处理时间的一种工具。但假如操作系统本身支持多个处理器，那么每个线程都可分配给一个不同的处理器，真正 进入“并行运算”状态。从程序设计语言的角度看，多线程操作最有价值的特性之一就是程序员不必关心到底使用了多少个处理器。程序在逻辑意义上被分割为数个 线程;假如机器本身安装了多个处理器，那么程序会运行得更快，毋需作出任何特殊的调校。根据前面的论述，大家可能感觉线程处理非常简单。但必须注意一个问 题：共享资源!如果有多个线程同时运行，而且它们试图访问相同的资源，就会遇到一个问题。举个例子来说，两个线程不能将信息同时发送给一台打印机。为解决 这个问题，对那些可共享的资源来说(比如打印机)，它们在使用期间必须进入锁定状态。所以一个线程可将资源锁定，在完成了它的任务后，再解开(释放)这个 锁，使其他线程可以接着使用同样的资源。

+ 多线程是为了同步完成多项任务，不是为了提高运行效率，而是为了提高资源使用效率来提高系统的效率。线程是在同一时间需要完成多项任务的时候实现的。

+ 一个采用了多线程技术的应用程序可以更好地利用系统资源。其主要优势在于充分利用了CPU的空闲时间片，可以用尽可能少的时间来对用户的要求做 出响应，使得进程的整体运行效率得到较大提高，同时增强了应用程序的灵活性。更为重要的是，由于同一进程的所有线程是共享同一内存，所以不需要特殊的数据 传送机制，不需要建立共享存储区或共享文件，从而使得不同任务之间的协调操作与运行、数据的交互、资源的分配等问题更加易于解决。

+ 进程间通信(IPC，Inter-Process Communication)，指至少两个进程或线程间传送数据或信号的一些技术或方法。进程是计算机系统分配资源的最小单位。每个进程都有自己的一部分 独立的系统资源，彼此是隔离的。为了能使不同的进程互相访问资源并进行协调工作，才有了进程间通信。这些进程可以运行在同一计算机上或网络连接的不同计算 机上。

+ 进程间通信技术包括消息传递、同步、共享内存和远程过程调用。IPC是一种标准的Unix通信机制。

+ 使用IPC 的理由：信息共享、加速、模块化、方便以及私有权分离。

+ 主要的 IPC 方法
 - 方法 提供方(操作系统或其他环境)
 - 文件 多数操作系统
 - 信号 多数操作系统
 - Socket 多数操作系统
 - 消息队列(en:Message queue) 多数操作系统
 - 管道(en:Pipe) 所有的 POSIX systems, Windows.
 - 具名管道(en:Named Pipe) 所有的 POSIX 系统, Windows.
 - 信号量(en:Semaphore) 所有的 POSIX 系统, Windows.
 - 共享内存 所有的 POSIX 系统, Windows.
 - Message passing(en:Message passing) 用于 MPI规范，Java RMI, CORBA, MSMQ, MailSlot 以及其他.

## LInux怎么运行的？底层原理？

+ Linux是一个开源的操作系统，底层原理基于内核和进程管理。  
+ 当Linux启动时，它会加载内核并创建一个称为init的进程。init进程是Linux系统中的第一个进程，它负责初始化系统并启动其他进程。
+ Linux的内核是操作系统的核心部分，它负责管理系统的硬件和资源。内核会加载驱动程序来控制各种硬件设备，例如处理器、内存、硬盘、网络等等。内核还负责分配和管理系统资源，例如内存、进程、文件系统等等。
+ Linux使用进程管理来控制系统中运行的程序。每个程序都运行在一个进程中，进程可以通过fork()系统调用来创建新的进程。进程之间可以通过管道、共享内存、信号等机制来进行通信和同步。
+ Linux还具有高度的可定制性和模块化架构。Linux内核支持加载和卸载内核模块，这些模块可以添加或修改内核功能，以实现各种需求，例如驱动程序、文件系统、网络协议等等。这些模块可以在运行时动态加载或卸载，这使得Linux非常灵活和可扩展。
+ 综上所述，Linux的底层原理是基于内核和进程管理的，这些特点使得它成为一个高性能、可靠和可定制的操作系统。

## 并发和并行的区别  

并发和并行的区别主要在于处理任务的方式、存在的形式和CPU资源的利用方式不同

+ 并发是一个CPU处理器同时处理多个线程任务，宏观上是同时处理多个任务，微观上其实是CPU在多个线程之间快速的交替执行，CPU把运行时间划分成若干个(微小)时间段，公平的分配给各个线程执行，在一个时间段的线程运行时，其他线程处于挂起状态，这种就称之为并发。而并行是多个CPU处理器同时处理多个线程任务，当一个CPU执行一个线程时，另一个CPU可以执行另一个线程，两个线程互不抢占CPU资源，可以同时进行，这就被称之为并行。
+ 存在的形式也不同，即并发是把任务在不同的时间点交给处理器进行处理，而并行则是把每一个任务分配给每一个处理器独立完成。
+ CPU资源的利用方式不同，即并发是一个CPU处理器在多个线程之间快速切换，而并行是多个CPU处理器同时处理多个线程任务。

